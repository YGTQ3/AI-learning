# ğŸ“ AI å­¦ä¹ åŠ©æ‰‹ï¼ˆAI Learning Assistantï¼‰

ä¸€ä¸ªåŸºäº React + Supabase çš„ **ä¸ªäººå­¦ä¹ ç®¡ç†å·¥å…·**ï¼Œå¸®åŠ©ç”¨æˆ·é«˜æ•ˆè§„åˆ’å­¦ä¹ ä»»åŠ¡ã€ç®¡ç†èµ„æºã€è¿½è¸ªè¿›åº¦ï¼Œå¹¶æ”¯æŒç¤¾äº¤åˆ†äº«ä¸å¤šè®¾å¤‡åŒæ­¥ã€‚

---

## ğŸ” æ ¸å¿ƒåŠŸèƒ½

- **ä»»åŠ¡ç®¡ç†**  
  ğŸ“… åˆ›å»º/ç¼–è¾‘å­¦ä¹ ä»»åŠ¡ï¼Œè®¾ç½®ä¼˜å…ˆçº§ã€æ—¶é—´ã€åˆ†ç±»  
  ğŸ”„ æœ¬åœ°ç¼“å­˜ + è‡ªåŠ¨åŒæ­¥åˆ° Supabase äº‘ç«¯  
  ğŸ“Š å­¦ä¹ è¿›åº¦ç»Ÿè®¡ä¸å¯è§†åŒ–ï¼ˆå›¾è¡¨å±•ç¤ºï¼‰

- **èµ„æºç®¡ç†**  
  ğŸ“ æ”¯æŒå¤šç§èµ„æºç±»å‹ï¼ˆè§†é¢‘ã€æ–‡æ¡£ã€é“¾æ¥ç­‰ï¼‰  
  â­ è¯„åˆ†ã€æ”¶è—ã€æ ‡ç­¾åˆ†ç±»ï¼Œæ™ºèƒ½ç­›é€‰  
  ğŸ“¥ èµ„æºä¸‹è½½ä¸åˆ†äº«åŠŸèƒ½

- **ç¤¾äº¤äº’åŠ¨**  
  ğŸŒ æ”¯æŒèµ„æºä¸€é”®åˆ†äº«ï¼ˆæµè§ˆå™¨åŸç”Ÿåˆ†äº«æˆ–å¤åˆ¶é“¾æ¥ï¼‰  
  ğŸ‘¥ æŸ¥çœ‹ä»–äººåˆ†äº«çš„å­¦ä¹ èµ„æºï¼ˆç¤¾äº¤æ¨¡å—å¯æ‰©å±•ï¼‰

- **ç”¨æˆ·ç³»ç»Ÿ**  
  ğŸ” Supabase è®¤è¯ï¼ˆé‚®ç®±/å¯†ç  + ç¬¬ä¸‰æ–¹ç™»å½•ï¼‰  
  ğŸ¨ ä¸»é¢˜åˆ‡æ¢ï¼ˆäº®/æš—/è·Ÿéšç³»ç»Ÿï¼‰ã€é€šçŸ¥è®¾ç½®  
  ğŸ“± å¤šè®¾å¤‡åŒæ­¥ï¼ˆè®°å½•è®¾å¤‡ä¿¡æ¯ï¼‰

---

## ğŸ§° æŠ€æœ¯æ ˆ

- **å‰ç«¯**  
  React + TypeScript  
  Tailwind CSS + Framer Motionï¼ˆåŠ¨ç”»ï¼‰  
  Supabase å®¢æˆ·ç«¯ï¼ˆå®æ—¶æ•°æ®åº“ + è®¤è¯ï¼‰

- **åç«¯**  
  Supabaseï¼ˆPostgreSQL æ•°æ®åº“ + RLS æƒé™æ§åˆ¶ï¼‰  
  æ•°æ®è¡¨ï¼šç”¨æˆ·ã€ä»»åŠ¡ã€èµ„æºã€è®¾ç½®ã€è®¾å¤‡ã€åŒæ­¥æ—¥å¿—ç­‰

- **å·¥å…·**  
  `localStorage` ç¦»çº¿ç¼“å­˜ + é˜²æŠ–åŒæ­¥  
  `sonner` é€šçŸ¥ã€`recharts` æ•°æ®å¯è§†åŒ–  
  `zod` è¡¨å•éªŒè¯ã€`date-fns` æ—¥æœŸå¤„ç†



## ğŸŒŸ é¡¹ç›®äº®ç‚¹

- **ç¦»çº¿ä¼˜å…ˆ**ï¼šæœ¬åœ°æ“ä½œæµç•…ï¼Œç½‘ç»œæ¢å¤åè‡ªåŠ¨åŒæ­¥  
- **æ¨¡å—åŒ–è®¾è®¡**ï¼šä¸»åº”ç”¨ä¸ç¤¾äº¤æ¡†æ¶åˆ†ç¦»ï¼Œä¾¿äºå¤ç”¨  
- **æ•°æ®é©±åŠ¨**ï¼šå­¦ä¹ ç»Ÿè®¡ä¸å¯è§†åŒ–ï¼Œæ´å¯Ÿå­¦ä¹ ä¹ æƒ¯  
- **å®‰å…¨è®¤è¯**ï¼šSupabase RLS ç­–ç•¥ä¿éšœç”¨æˆ·æ•°æ®éš”ç¦»

---

## ğŸ“¦ é€‚ç”¨åœºæ™¯

- å­¦ç”Ÿï¼šä»»åŠ¡è§„åˆ’ã€è€ƒè¯•å¤ä¹ ã€èµ„æºæ•´ç†  
- èŒåœºäººå£«ï¼šæŠ€èƒ½æå‡ã€çŸ¥è¯†ç®¡ç†  
- æ•™è‚²å¹³å°ï¼šä¸ªæ€§åŒ–å­¦ä¹ è·¯å¾„å·¥å…·  
- å¼€å‘è€…ï¼šReact + Supabase é¡¹ç›®æ¨¡æ¿




### å‰ç«¯

åŸºäºnode.jsï¼Œpnpmå®ç°

é¦–å…ˆå®‰è£…node.jså’Œpnpm,è¿™é‡Œä½¿ç”¨äº†é˜¿é‡Œäº‘**Alibaba Cloud Linux 3**ï¼Œä¸”å‹¾é€‰äº†è‡ªåŠ¨å®‰è£…node.js 20ç‰ˆæœ¬ï¼Œæ‰€ä»¥å®‰è£…è¿‡ç¨‹å¯ç›´æ¥çœå»ã€‚

#### ä¸Šä¼ é¡¹ç›®æ–‡ä»¶

```
è¿›å…¥æ–‡ä»¶ç›®å½•
pnpm install
pnpm run dev
```

å³å¯è¿è¡Œå‰ç«¯



```
pnpm install @supabase/supabase-js   #åç«¯éœ€è¦ç»„ä»¶
```

---------------------

ä½¿ç”¨ä¸‹é¢å‘½ä»¤å®ç°åå°è¿è¡Œ

```
nohup pnpm run dev > output.log 2>&1 &
```

å…³é—­ç»ˆç«¯æ—¶è¦å…ˆï¼Œexité€€å‡ºç™»å½•ï¼Œå†å…³é—­ç»ˆç«¯



### åç«¯

ç°åœ¨æ˜¯ä½¿ç”¨çš„Supabaseåšæ•°æ®çš„å­˜å‚¨

#### æ•°æ®åº“åˆå§‹åŒ–sqlè„šæœ¬

```
-- å¯ç”¨å¿…è¦çš„æ‰©å±•
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- 1. ç”¨æˆ·è¡¨ (æ‰©å±• auth.users)
CREATE TABLE public.users (
  id UUID REFERENCES auth.users(id) ON DELETE CASCADE PRIMARY KEY,
  email TEXT UNIQUE NOT NULL,
  username TEXT UNIQUE NOT NULL,
  avatar_url TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 2. å­¦ä¹ ä»»åŠ¡è¡¨
CREATE TABLE public.learning_tasks (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  user_id UUID REFERENCES public.users(id) ON DELETE CASCADE NOT NULL,
  title TEXT NOT NULL,
  description TEXT,
  start_time TIME NOT NULL,
  end_time TIME NOT NULL,
  date DATE NOT NULL,
  completed BOOLEAN DEFAULT FALSE,
  category TEXT NOT NULL,
  priority TEXT CHECK (priority IN ('low', 'medium', 'high')) DEFAULT 'medium',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 3. å­¦ä¹ èµ„æºè¡¨
CREATE TABLE public.learning_resources (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  user_id UUID REFERENCES public.users(id) ON DELETE CASCADE NOT NULL,
  title TEXT NOT NULL,
  description TEXT,
  category TEXT NOT NULL,
  type TEXT CHECK (type IN ('video', 'document', 'audio', 'image', 'link')) DEFAULT 'document',
  url TEXT,
  file_url TEXT,
  tags TEXT[] DEFAULT '{}',
  rating DECIMAL(2,1) CHECK (rating >= 0 AND rating <= 5) DEFAULT 0,
  difficulty TEXT CHECK (difficulty IN ('beginner', 'intermediate', 'advanced')) DEFAULT 'beginner',
  duration INTEGER, -- åˆ†é’Ÿ
  size BIGINT, -- å­—èŠ‚
  uploaded_by UUID REFERENCES public.users(id),
  download_count INTEGER DEFAULT 0,
  is_favorite BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 4. ç”¨æˆ·è®¾ç½®è¡¨
CREATE TABLE public.user_settings (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  user_id UUID REFERENCES public.users(id) ON DELETE CASCADE UNIQUE NOT NULL,
  theme TEXT CHECK (theme IN ('light', 'dark', 'system')) DEFAULT 'light',
  notifications JSONB DEFAULT '{
    "enabled": false,
    "taskReminders": true,
    "dailyGoals": true,
    "studyBreaks": true,
    "reviewReminders": true
  }'::jsonb,
  timezone TEXT DEFAULT 'Asia/Shanghai',
  language TEXT DEFAULT 'zh-CN',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 5. å­¦ä¹ ç»Ÿè®¡è¡¨
CREATE TABLE public.learning_stats (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  user_id UUID REFERENCES public.users(id) ON DELETE CASCADE NOT NULL,
  date DATE NOT NULL,
  total_study_time INTEGER DEFAULT 0, -- åˆ†é’Ÿ
  completed_tasks INTEGER DEFAULT 0,
  total_tasks INTEGER DEFAULT 0,
  categories_studied TEXT[] DEFAULT '{}',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(user_id, date)
);

-- 6. è®¾å¤‡ç®¡ç†è¡¨
CREATE TABLE public.user_devices (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  user_id UUID REFERENCES public.users(id) ON DELETE CASCADE NOT NULL,
  device_name TEXT NOT NULL,
  device_type TEXT CHECK (device_type IN ('desktop', 'mobile', 'tablet')) DEFAULT 'desktop',
  device_id TEXT NOT NULL, -- æµè§ˆå™¨æŒ‡çº¹æˆ–è®¾å¤‡å”¯ä¸€æ ‡è¯†
  user_agent TEXT,
  ip_address INET,
  last_active TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  is_current BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(user_id, device_id)
);

-- 7. åŒæ­¥æ—¥å¿—è¡¨ (ç”¨äºè°ƒè¯•å’Œç›‘æ§)
CREATE TABLE public.sync_logs (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  user_id UUID REFERENCES public.users(id) ON DELETE CASCADE NOT NULL,
  device_id UUID REFERENCES public.user_devices(id) ON DELETE SET NULL,
  sync_type TEXT NOT NULL, -- 'full', 'incremental', 'conflict_resolution'
  table_name TEXT NOT NULL,
  operation TEXT CHECK (operation IN ('insert', 'update', 'delete', 'conflict')) NOT NULL,
  record_id UUID,
  status TEXT CHECK (status IN ('success', 'error', 'conflict')) DEFAULT 'success',
  error_message TEXT,
  sync_duration INTEGER, -- æ¯«ç§’
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•ä»¥æé«˜æŸ¥è¯¢æ€§èƒ½
CREATE INDEX idx_learning_tasks_user_date ON public.learning_tasks(user_id, date);
CREATE INDEX idx_learning_tasks_category ON public.learning_tasks(category);
CREATE INDEX idx_learning_resources_user_category ON public.learning_resources(user_id, category);
CREATE INDEX idx_learning_resources_tags ON public.learning_resources USING GIN(tags);
CREATE INDEX idx_learning_stats_user_date ON public.learning_stats(user_id, date);
CREATE INDEX idx_user_devices_user_active ON public.user_devices(user_id, last_active);
CREATE INDEX idx_sync_logs_user_created ON public.sync_logs(user_id, created_at);

-- åˆ›å»ºæ›´æ–°æ—¶é—´è§¦å‘å™¨å‡½æ•°
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ language 'plpgsql';

-- ä¸ºæ‰€æœ‰è¡¨æ·»åŠ æ›´æ–°æ—¶é—´è§¦å‘å™¨
CREATE TRIGGER update_users_updated_at BEFORE UPDATE ON public.users
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_learning_tasks_updated_at BEFORE UPDATE ON public.learning_tasks
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_learning_resources_updated_at BEFORE UPDATE ON public.learning_resources
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_user_settings_updated_at BEFORE UPDATE ON public.user_settings
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_learning_stats_updated_at BEFORE UPDATE ON public.learning_stats
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

```
-- å¯ç”¨æ‰€æœ‰è¡¨çš„ RLS
ALTER TABLE public.users ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.learning_tasks ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.learning_resources ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_settings ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.learning_stats ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_devices ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.sync_logs ENABLE ROW LEVEL SECURITY;

-- ================================
-- ç”¨æˆ·è¡¨ç­–ç•¥
-- ================================

-- ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„ä¿¡æ¯
CREATE POLICY "Users can view own profile" ON public.users
  FOR SELECT USING (auth.uid() = id);

-- ç”¨æˆ·å¯ä»¥æ›´æ–°è‡ªå·±çš„ä¿¡æ¯
CREATE POLICY "Users can update own profile" ON public.users
  FOR UPDATE USING (auth.uid() = id);

-- ç”¨æˆ·æ³¨å†Œæ—¶å¯ä»¥æ’å…¥è‡ªå·±çš„ä¿¡æ¯
CREATE POLICY "Users can insert own profile" ON public.users
  FOR INSERT WITH CHECK (auth.uid() = id);

-- ================================
-- å­¦ä¹ ä»»åŠ¡è¡¨ç­–ç•¥
-- ================================

-- ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„ä»»åŠ¡
CREATE POLICY "Users can view own tasks" ON public.learning_tasks
  FOR SELECT USING (auth.uid() = user_id);

-- ç”¨æˆ·å¯ä»¥åˆ›å»ºè‡ªå·±çš„ä»»åŠ¡
CREATE POLICY "Users can create own tasks" ON public.learning_tasks
  FOR INSERT WITH CHECK (auth.uid() = user_id);

-- ç”¨æˆ·å¯ä»¥æ›´æ–°è‡ªå·±çš„ä»»åŠ¡
CREATE POLICY "Users can update own tasks" ON public.learning_tasks
  FOR UPDATE USING (auth.uid() = user_id);

-- ç”¨æˆ·å¯ä»¥åˆ é™¤è‡ªå·±çš„ä»»åŠ¡
CREATE POLICY "Users can delete own tasks" ON public.learning_tasks
  FOR DELETE USING (auth.uid() = user_id);

-- ================================
-- å­¦ä¹ èµ„æºè¡¨ç­–ç•¥
-- ================================

-- ç”¨æˆ·å¯ä»¥æŸ¥çœ‹è‡ªå·±çš„èµ„æº
CREATE POLICY "Users can view own resources" ON public.learning_resources
  FOR SELECT USING (auth.uid() = user_id);

-- ç”¨æˆ·å¯ä»¥åˆ›å»ºè‡ªå·±çš„èµ„æº
CREATE POLICY "Users can create own resources" ON public.learning_resources
  FOR INSERT WITH CHECK (auth.uid() = user_id);

-- ç”¨æˆ·å¯ä»¥æ›´æ–°è‡ªå·±çš„èµ„æº
CREATE POLICY "Users can update own resources" ON public.learning_resources
  FOR UPDATE USING (auth.uid() = user_id);

-- ç”¨æˆ·å¯ä»¥åˆ é™¤è‡ªå·±çš„èµ„æº
CREATE POLICY "Users can delete own resources" ON public.learning_resources
  FOR DELETE USING (auth.uid() = user_id);

-- ================================
-- ç”¨æˆ·è®¾ç½®è¡¨ç­–ç•¥
-- ================================

-- ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„è®¾ç½®
CREATE POLICY "Users can view own settings" ON public.user_settings
  FOR SELECT USING (auth.uid() = user_id);

-- ç”¨æˆ·å¯ä»¥åˆ›å»ºè‡ªå·±çš„è®¾ç½®
CREATE POLICY "Users can create own settings" ON public.user_settings
  FOR INSERT WITH CHECK (auth.uid() = user_id);

-- ç”¨æˆ·å¯ä»¥æ›´æ–°è‡ªå·±çš„è®¾ç½®
CREATE POLICY "Users can update own settings" ON public.user_settings
  FOR UPDATE USING (auth.uid() = user_id);

-- ================================
-- å­¦ä¹ ç»Ÿè®¡è¡¨ç­–ç•¥
-- ================================

-- ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„ç»Ÿè®¡
CREATE POLICY "Users can view own stats" ON public.learning_stats
  FOR SELECT USING (auth.uid() = user_id);

-- ç”¨æˆ·å¯ä»¥åˆ›å»ºè‡ªå·±çš„ç»Ÿè®¡
CREATE POLICY "Users can create own stats" ON public.learning_stats
  FOR INSERT WITH CHECK (auth.uid() = user_id);

-- ç”¨æˆ·å¯ä»¥æ›´æ–°è‡ªå·±çš„ç»Ÿè®¡
CREATE POLICY "Users can update own stats" ON public.learning_stats
  FOR UPDATE USING (auth.uid() = user_id);

-- ================================
-- è®¾å¤‡ç®¡ç†è¡¨ç­–ç•¥
-- ================================

-- ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„è®¾å¤‡
CREATE POLICY "Users can view own devices" ON public.user_devices
  FOR SELECT USING (auth.uid() = user_id);

-- ç”¨æˆ·å¯ä»¥æ³¨å†Œè‡ªå·±çš„è®¾å¤‡
CREATE POLICY "Users can register own devices" ON public.user_devices
  FOR INSERT WITH CHECK (auth.uid() = user_id);

-- ç”¨æˆ·å¯ä»¥æ›´æ–°è‡ªå·±çš„è®¾å¤‡ä¿¡æ¯
CREATE POLICY "Users can update own devices" ON public.user_devices
  FOR UPDATE USING (auth.uid() = user_id);

-- ç”¨æˆ·å¯ä»¥åˆ é™¤è‡ªå·±çš„è®¾å¤‡
CREATE POLICY "Users can delete own devices" ON public.user_devices
  FOR DELETE USING (auth.uid() = user_id);

-- ================================
-- åŒæ­¥æ—¥å¿—è¡¨ç­–ç•¥
-- ================================

-- ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„åŒæ­¥æ—¥å¿—
CREATE POLICY "Users can view own sync logs" ON public.sync_logs
  FOR SELECT USING (auth.uid() = user_id);

-- ç³»ç»Ÿå¯ä»¥åˆ›å»ºåŒæ­¥æ—¥å¿—
CREATE POLICY "System can create sync logs" ON public.sync_logs
  FOR INSERT WITH CHECK (auth.uid() = user_id);
```

```
-- ================================
-- è‡ªåŠ¨åˆ›å»ºç”¨æˆ·èµ„æ–™å‡½æ•°
-- ================================

CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.users (id, email, username)
  VALUES (
    NEW.id,
    NEW.email,
    COALESCE(NEW.raw_user_meta_data->>'username', split_part(NEW.email, '@', 1))
  );
  
  -- åˆ›å»ºé»˜è®¤è®¾ç½®
  INSERT INTO public.user_settings (user_id)
  VALUES (NEW.id);
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- å½“æ–°ç”¨æˆ·æ³¨å†Œæ—¶è‡ªåŠ¨åˆ›å»ºèµ„æ–™
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();

-- ================================
-- æ›´æ–°å­¦ä¹ ç»Ÿè®¡å‡½æ•°
-- ================================

CREATE OR REPLACE FUNCTION public.update_learning_stats()
RETURNS TRIGGER AS $$
DECLARE
  task_date DATE;
  study_duration INTEGER;
BEGIN
  -- è·å–ä»»åŠ¡æ—¥æœŸ
  IF TG_OP = 'DELETE' THEN
    task_date := OLD.date;
  ELSE
    task_date := NEW.date;
  END IF;

  -- è®¡ç®—å­¦ä¹ æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
  IF TG_OP = 'DELETE' THEN
    study_duration := EXTRACT(EPOCH FROM (OLD.end_time - OLD.start_time)) / 60;
  ELSE
    study_duration := EXTRACT(EPOCH FROM (NEW.end_time - NEW.start_time)) / 60;
  END IF;

  -- æ›´æ–°æˆ–æ’å…¥ç»Ÿè®¡æ•°æ®
  INSERT INTO public.learning_stats (user_id, date, total_study_time, completed_tasks, total_tasks, categories_studied)
  VALUES (
    COALESCE(NEW.user_id, OLD.user_id),
    task_date,
    CASE 
      WHEN TG_OP = 'DELETE' THEN -study_duration
      WHEN TG_OP = 'INSERT' THEN study_duration
      WHEN TG_OP = 'UPDATE' AND NEW.completed != OLD.completed THEN 0
      ELSE study_duration - EXTRACT(EPOCH FROM (OLD.end_time - OLD.start_time)) / 60
    END,
    CASE 
      WHEN TG_OP = 'DELETE' AND OLD.completed THEN -1
      WHEN TG_OP = 'INSERT' AND NEW.completed THEN 1
      WHEN TG_OP = 'UPDATE' AND NEW.completed != OLD.completed THEN 
        CASE WHEN NEW.completed THEN 1 ELSE -1 END
      ELSE 0
    END,
    CASE 
      WHEN TG_OP = 'DELETE' THEN -1
      WHEN TG_OP = 'INSERT' THEN 1
      ELSE 0
    END,
    ARRAY[COALESCE(NEW.category, OLD.category)]
  )
  ON CONFLICT (user_id, date) 
  DO UPDATE SET
    total_study_time = learning_stats.total_study_time + EXCLUDED.total_study_time,
    completed_tasks = learning_stats.completed_tasks + EXCLUDED.completed_tasks,
    total_tasks = learning_stats.total_tasks + EXCLUDED.total_tasks,
    categories_studied = array_cat(learning_stats.categories_studied, EXCLUDED.categories_studied),
    updated_at = NOW();

  RETURN COALESCE(NEW, OLD);
END;
$$ LANGUAGE plpgsql;

-- ä»»åŠ¡å˜åŒ–æ—¶æ›´æ–°ç»Ÿè®¡
CREATE TRIGGER update_stats_on_task_change
  AFTER INSERT OR UPDATE OR DELETE ON public.learning_tasks
  FOR EACH ROW EXECUTE FUNCTION public.update_learning_stats();

-- ================================
-- è®¾å¤‡ç®¡ç†å‡½æ•°
-- ================================

CREATE OR REPLACE FUNCTION public.register_device(
  device_name TEXT,
  device_type TEXT DEFAULT 'desktop',
  device_id TEXT DEFAULT NULL,
  user_agent TEXT DEFAULT NULL
)
RETURNS UUID AS $$
DECLARE
  new_device_id UUID;
  current_user_id UUID;
BEGIN
  current_user_id := auth.uid();
  
  IF current_user_id IS NULL THEN
    RAISE EXCEPTION 'User not authenticated';
  END IF;

  -- ç”Ÿæˆè®¾å¤‡IDï¼ˆå¦‚æœæœªæä¾›ï¼‰
  IF device_id IS NULL THEN
    device_id := gen_random_uuid()::TEXT;
  END IF;

  -- å°†å…¶ä»–è®¾å¤‡è®¾ä¸ºéå½“å‰è®¾å¤‡
  UPDATE public.user_devices 
  SET is_current = FALSE 
  WHERE user_id = current_user_id;

  -- æ’å…¥æˆ–æ›´æ–°è®¾å¤‡ä¿¡æ¯
  INSERT INTO public.user_devices (
    user_id, 
    device_name, 
    device_type, 
    device_id, 
    user_agent, 
    ip_address,
    is_current,
    last_active
  )
  VALUES (
    current_user_id,
    device_name,
    device_type,
    device_id,
    user_agent,
    inet_client_addr(),
    TRUE,
    NOW()
  )
  ON CONFLICT (user_id, device_id)
  DO UPDATE SET
    device_name = EXCLUDED.device_name,
    device_type = EXCLUDED.device_type,
    user_agent = EXCLUDED.user_agent,
    ip_address = EXCLUDED.ip_address,
    is_current = TRUE,
    last_active = NOW()
  RETURNING id INTO new_device_id;

  RETURN new_device_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ================================
-- åŒæ­¥æ—¥å¿—å‡½æ•°
-- ================================

CREATE OR REPLACE FUNCTION public.log_sync_operation(
  sync_type TEXT,
  table_name TEXT,
  operation TEXT,
  record_id UUID DEFAULT NULL,
  status TEXT DEFAULT 'success',
  error_message TEXT DEFAULT NULL,
  sync_duration INTEGER DEFAULT NULL
)
RETURNS UUID AS $$
DECLARE
  log_id UUID;
  current_user_id UUID;
  current_device_id UUID;
BEGIN
  current_user_id := auth.uid();
  
  IF current_user_id IS NULL THEN
    RAISE EXCEPTION 'User not authenticated';
  END IF;

  -- è·å–å½“å‰è®¾å¤‡ID
  SELECT id INTO current_device_id
  FROM public.user_devices
  WHERE user_id = current_user_id AND is_current = TRUE
  LIMIT 1;

  INSERT INTO public.sync_logs (
    user_id,
    device_id,
    sync_type,
    table_name,
    operation,
    record_id,
    status,
    error_message,
    sync_duration
  )
  VALUES (
    current_user_id,
    current_device_id,
    sync_type,
    table_name,
    operation,
    record_id,
    status,
    error_message,
    sync_duration
  )
  RETURNING id INTO log_id;

  RETURN log_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

```
-- ================================
-- æ’å…¥ç¤ºä¾‹åˆ†ç±»æ•°æ®
-- ================================

-- åˆ›å»ºåˆ†ç±»è¡¨ï¼ˆå¯é€‰ï¼Œç”¨äºæ ‡å‡†åŒ–åˆ†ç±»ï¼‰
CREATE TABLE IF NOT EXISTS public.categories (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  name TEXT UNIQUE NOT NULL,
  icon TEXT,
  color TEXT,
  description TEXT,
  is_system BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- æ’å…¥é»˜è®¤åˆ†ç±»
INSERT INTO public.categories (name, icon, color, description) VALUES
  ('æ•°å­¦', 'fa-calculator', '#3B82F6', 'æ•°å­¦ç›¸å…³å­¦ä¹ å†…å®¹'),
  ('ç‰©ç†', 'fa-atom', '#10B981', 'ç‰©ç†å­¦ç§‘å­¦ä¹ èµ„æº'),
  ('è‹±è¯­', 'fa-language', '#F59E0B', 'è‹±è¯­è¯­è¨€å­¦ä¹ '),
  ('ç¼–ç¨‹', 'fa-code', '#8B5CF6', 'ç¼–ç¨‹æŠ€æœ¯å­¦ä¹ '),
  ('å†å²', 'fa-landmark', '#EF4444', 'å†å²æ–‡åŒ–å­¦ä¹ '),
  ('ç”Ÿç‰©', 'fa-dna', '#06B6D4', 'ç”Ÿç‰©ç§‘å­¦å­¦ä¹ '),
  ('åŒ–å­¦', 'fa-flask', '#84CC16', 'åŒ–å­¦å®éªŒå­¦ä¹ '),
  ('æ–‡å­¦', 'fa-book-open', '#F97316', 'æ–‡å­¦ä½œå“é˜…è¯»'),
  ('è‰ºæœ¯', 'fa-palette', '#EC4899', 'è‰ºæœ¯åˆ›ä½œå­¦ä¹ '),
  ('éŸ³ä¹', 'fa-music', '#6366F1', 'éŸ³ä¹ç†è®ºå®è·µ');

-- ä¸ºåˆ†ç±»è¡¨å¯ç”¨ RLS
ALTER TABLE public.categories ENABLE ROW LEVEL SECURITY;

-- æ‰€æœ‰ç”¨æˆ·éƒ½å¯ä»¥æŸ¥çœ‹åˆ†ç±»
CREATE POLICY "Everyone can view categories" ON public.categories
  FOR SELECT USING (true);

-- ================================
-- åˆ›å»ºè§†å›¾ç”¨äºæ•°æ®åˆ†æ
-- ================================

-- ç”¨æˆ·å­¦ä¹ æ¦‚è§ˆè§†å›¾
CREATE OR REPLACE VIEW public.user_learning_overview AS
SELECT 
  u.id as user_id,
  u.username,
  u.email,
  COUNT(DISTINCT lt.id) as total_tasks,
  COUNT(DISTINCT CASE WHEN lt.completed THEN lt.id END) as completed_tasks,
  COUNT(DISTINCT lr.id) as total_resources,
  COUNT(DISTINCT lt.category) as categories_count,
  COALESCE(SUM(EXTRACT(EPOCH FROM (lt.end_time - lt.start_time)) / 60), 0) as total_study_minutes,
  MAX(lt.created_at) as last_task_created,
  MAX(lr.created_at) as last_resource_added
FROM public.users u
LEFT JOIN public.learning_tasks lt ON u.id = lt.user_id
LEFT JOIN public.learning_resources lr ON u.id = lr.user_id
GROUP BY u.id, u.username, u.email;

-- æ¯æ—¥å­¦ä¹ ç»Ÿè®¡è§†å›¾
CREATE OR REPLACE VIEW public.daily_learning_stats AS
SELECT 
  ls.*,
  u.username,
  ROUND((ls.completed_tasks::DECIMAL / NULLIF(ls.total_tasks, 0)) * 100, 2) as completion_rate
FROM public.learning_stats ls
JOIN public.users u ON ls.user_id = u.id
ORDER BY ls.date DESC;

-- çƒ­é—¨åˆ†ç±»è§†å›¾
CREATE OR REPLACE VIEW public.popular_categories AS
SELECT 
  category,
  COUNT(*) as task_count,
  COUNT(DISTINCT user_id) as user_count,
  AVG(EXTRACT(EPOCH FROM (end_time - start_time)) / 60) as avg_duration_minutes
FROM public.learning_tasks
GROUP BY category
ORDER BY task_count DESC;
```

```
-- åˆ é™¤ç°æœ‰ç­–ç•¥ï¼ˆå¦‚æœæœ‰ï¼‰
DROP POLICY IF EXISTS "Users can view own profile" ON users;
DROP POLICY IF EXISTS "Users can insert own profile" ON users;
DROP POLICY IF EXISTS "Users can update own profile" ON users;
DROP POLICY IF EXISTS "Users can delete own profile" ON users;

-- 1. å…è®¸è®¤è¯ç”¨æˆ·æŸ¥çœ‹è‡ªå·±çš„èµ„æ–™
CREATE POLICY "Users can view own profile" ON users
FOR SELECT TO authenticated
USING (auth.uid() = id);

-- 2. å…è®¸è®¤è¯ç”¨æˆ·æ’å…¥è‡ªå·±çš„èµ„æ–™
CREATE POLICY "Users can insert own profile" ON users
FOR INSERT TO authenticated
WITH CHECK (auth.uid() = id);

-- 3. å…è®¸è®¤è¯ç”¨æˆ·æ›´æ–°è‡ªå·±çš„èµ„æ–™
CREATE POLICY "Users can update own profile" ON users
FOR UPDATE TO authenticated
USING (auth.uid() = id)
WITH CHECK (auth.uid() = id);

-- 4. å…è®¸è®¤è¯ç”¨æˆ·åˆ é™¤è‡ªå·±çš„èµ„æ–™
CREATE POLICY "Users can delete own profile" ON users
FOR DELETE TO authenticated
USING (auth.uid() = id);
```

```
-- åˆ é™¤ç°æœ‰ç­–ç•¥ï¼ˆå¦‚æœæœ‰ï¼‰
DROP POLICY IF EXISTS "Users can view own settings" ON user_settings;
DROP POLICY IF EXISTS "Users can insert own settings" ON user_settings;
DROP POLICY IF EXISTS "Users can update own settings" ON user_settings;
DROP POLICY IF EXISTS "Users can delete own settings" ON user_settings;

-- 1. å…è®¸è®¤è¯ç”¨æˆ·æŸ¥çœ‹è‡ªå·±çš„è®¾ç½®
CREATE POLICY "Users can view own settings" ON user_settings
FOR SELECT TO authenticated
USING (auth.uid() = user_id);

-- 2. å…è®¸è®¤è¯ç”¨æˆ·æ’å…¥è‡ªå·±çš„è®¾ç½®
CREATE POLICY "Users can insert own settings" ON user_settings
FOR INSERT TO authenticated
WITH CHECK (auth.uid() = user_id);

-- 3. å…è®¸è®¤è¯ç”¨æˆ·æ›´æ–°è‡ªå·±çš„è®¾ç½®
CREATE POLICY "Users can update own settings" ON user_settings
FOR UPDATE TO authenticated
USING (auth.uid() = user_id)
WITH CHECK (auth.uid() = user_id);

-- 4. å…è®¸è®¤è¯ç”¨æˆ·åˆ é™¤è‡ªå·±çš„è®¾ç½®
CREATE POLICY "Users can delete own settings" ON user_settings
FOR DELETE TO authenticated
USING (auth.uid() = user_id);
```

```
-- åˆ›å»ºä¸€ä¸ªå®‰å…¨çš„ç”¨æˆ·åˆ›å»ºå‡½æ•°
CREATE OR REPLACE FUNCTION create_user_profile(
  user_id UUID,
  user_email TEXT,
  user_name TEXT
)
RETURNS void
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  INSERT INTO users (id, email, username)
  VALUES (user_id, user_email, user_name)
  ON CONFLICT (id) DO UPDATE SET
    email = EXCLUDED.email,
    username = EXCLUDED.username,
    updated_at = NOW();
END;
$$;

-- æˆæƒç»™è®¤è¯ç”¨æˆ·ä½¿ç”¨
GRANT EXECUTE ON FUNCTION create_user_profile TO authenticated, anon;
```

#### å®Œæˆæ•°æ®åº“åˆå§‹åŒ–å

åœ¨é¡¹ç›®ä¸Šæ–¹æœ‰ connectï¼Œç‚¹å‡»åé€‰æ‹©åº”ç”¨ç¨‹åºæ¶æ„ï¼Œå°†.env.localå†…å®¹å¤åˆ¶åˆ°å‰ç«¯ä»£ç ä¸­çš„.env.local

ä½†è¦æ³¨æ„å‰ç«¯ä»£ç ä¸­çš„åç§°å’Œç»™çš„åç§°ä¸åŒï¼Œä¸è¦æ”¹

![image-20250721034226775](README.assets/image-20250721034226775-17530405500871.png)

è¿˜éœ€ä¸€æ­¥é…ç½®

![image-20250721034925649](README.assets/image-20250721034925649-17530409675702.png)

![image-20250721034940753](README.assets/image-20250721034940753-17530409824153.png)

Authenticationä¸­ï¼ŒURLé…ç½®ï¼Œç«™ç‚¹URLï¼Œé…ç½®æˆå‰ç«¯é¡µé¢çš„é“¾æ¥

è¿™æ ·æ”¶åˆ°éªŒè¯é‚®ä»¶åç‚¹å‡»é“¾æ¥å³å¯è·³è½¬åˆ°å‰ç«¯é¡µé¢å®ç°ç™»å½•





